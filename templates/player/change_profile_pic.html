{% extends 'base.html' %}

{% block content %}
<div style="max-width: 500px; margin: 40px auto; padding: 30px; border-radius: 15px; background-color: #f8f8f8; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center;">

  <h2 style="margin-bottom: 25px;">
    <i class="fa fa-image" aria-hidden="true"></i> Change Your Profile Picture
  </h2>

  <!-- Profile Picture Preview (hidden by default) -->
  <img id="preview" src="" alt="Profile Preview"
       style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 20px; border: 3px solid {{ user_obj.card_theme }}; box-shadow: 0 0 8px rgba(0,0,0,0.2); display: none;">

  <!-- File Input -->
  <input id="fileInput" type="file" accept="image/*" required style="
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
      width: 100%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 8px;
  ">

  <!-- Upload Button -->
  <button onclick="uploadImage()" style="
    background-color: {{ user_obj.card_theme }};
    padding: 10px 20px;
    color: white;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  ">
    <i class="fa fa-upload clr-white" aria-hidden="true"></i> Upload New Picture
  </button>

  <div id="msg" style="margin-top: 15px; color: green;"></div>
</div>

<script>
let base64String = "";

document.getElementById("fileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function (e) {
        base64String = e.target.result;

        // Show preview & update src
        const preview = document.getElementById("preview");
        preview.src = base64String;
        preview.style.display = "inline-block";
    };

    reader.readAsDataURL(file);
});

function uploadImage() {
    if (!base64String) {
        document.getElementById("msg").innerText = "Please select an image first.";
        return;
    }

    fetch("{% url 'change_profile_pic' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ image_data: base64String }),
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById("msg").innerText = data.message;
    })
    .catch(error => {
        console.error("Upload failed:", error);
        document.getElementById("msg").innerText = "Something went wrong!";
    });
}
</script>
{% endblock %}
